# Docker Compose for OnlyPerf Monorepo
# Usage:
#   1. Copy .env.example to .env at monorepo root (or set in Dokploy UI)
#   2. Run: docker-compose build && docker-compose up -d

services:
  onlyperf:
    build:
      context: .
      dockerfile: apps/onlyperf/Dockerfile
      secrets:
        - env
      args:
        # Public vars (baked into client bundle at build time)
        NEXT_PUBLIC_STORE_DOMAIN: ${NEXT_PUBLIC_STORE_DOMAIN}
        NEXT_PUBLIC_SITE_URL: ${NEXT_PUBLIC_SITE_URL:-https://onlyperf.com}
    ports:
      - "3000:3000"
    env_file:
      - .env
    environment:
      NODE_ENV: production
    restart: unless-stopped
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.onlyperf.rule=Host(`onlyperf.com`)"
      - "traefik.http.routers.onlyperf.entrypoints=websecure"
      - "traefik.http.routers.onlyperf.tls.certresolver=letsencrypt"
      - "traefik.http.services.onlyperf.loadbalancer.server.port=3000"

  warehouse:
    build:
      context: .
      dockerfile: apps/warehouse-management/Dockerfile
      secrets:
        - env
      args:
        # Public vars (baked into client bundle at build time)
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-https://warehouse.onlyperf.com}
        NEXT_PUBLIC_BASE_URL: ${NEXT_PUBLIC_BASE_URL:-https://onlyperf.com}
        NEXT_PUBLIC_SHOPIFY_ENABLED: ${NEXT_PUBLIC_SHOPIFY_ENABLED:-false}
    ports:
      - "3001:3001"
    env_file:
      - .env
    environment:
      NODE_ENV: production
      BETTER_AUTH_URL: ${BETTER_AUTH_URL:-http://localhost:3001}
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
    restart: unless-stopped
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.warehouse.rule=Host(`warehouse.onlyperf.com`)"
      - "traefik.http.routers.warehouse.entrypoints=websecure"
      - "traefik.http.routers.warehouse.tls.certresolver=letsencrypt"
      - "traefik.http.services.warehouse.loadbalancer.server.port=3001"

networks:
  dokploy-network:
    external: true

secrets:
  env:
    file: .env
