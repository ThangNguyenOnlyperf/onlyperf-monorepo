# Docker Compose for OnlyPerf Monorepo
# Usage:
#   1. Copy .env.example to .env at monorepo root
#   2. Copy apps/*/env.example to apps/*/.env.local for build secrets
#   3. Run: docker-compose build && docker-compose up -d

services:
  onlyperf:
    build:
      context: .
      dockerfile: apps/onlyperf/Dockerfile
      secrets:
        - env_onlyperf
      args:
        # Public vars (baked into client bundle at build time)
        NEXT_PUBLIC_STORE_DOMAIN: ${NEXT_PUBLIC_STORE_DOMAIN}
        NEXT_PUBLIC_SITE_URL: ${NEXT_PUBLIC_SITE_URL:-https://onlyperf.com}
    ports:
      - "3000:3000"
    environment:
      # Runtime environment variables
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL}
      # Shopify
      SHOPIFY_STORE_DOMAIN: ${SHOPIFY_STORE_DOMAIN}
      SHOPIFY_ADMIN_API_ACCESS_TOKEN: ${SHOPIFY_ADMIN_API_ACCESS_TOKEN}
      SHOPIFY_STOREFRONT_API_ACCESS_TOKEN: ${SHOPIFY_STOREFRONT_API_ACCESS_TOKEN}
      SHOPIFY_PRIVATE_STOREFRONT_API_TOKEN: ${SHOPIFY_PRIVATE_STOREFRONT_API_TOKEN}
      SHOPIFY_API_VERSION: ${SHOPIFY_API_VERSION:-2025-04}
      PUBLIC_STOREFRONT_API_TOKEN: ${PUBLIC_STOREFRONT_API_TOKEN}
      # Shopify Customer Account
      SHOPIFY_CUSTOMER_ACCOUNT_CLIENT_ID: ${SHOPIFY_CUSTOMER_ACCOUNT_CLIENT_ID}
      SHOPIFY_CUSTOMER_ACCOUNT_CLIENT_SECRET: ${SHOPIFY_CUSTOMER_ACCOUNT_CLIENT_SECRET}
      SHOPIFY_CUSTOMER_ACCOUNT_REDIRECT_URI: ${SHOPIFY_CUSTOMER_ACCOUNT_REDIRECT_URI}
      SHOPIFY_CUSTOMER_ACCOUNT_AUTH_URL: ${SHOPIFY_CUSTOMER_ACCOUNT_AUTH_URL}
      SHOPIFY_CUSTOMER_ACCOUNT_TOKEN_URL: ${SHOPIFY_CUSTOMER_ACCOUNT_TOKEN_URL}
      SHOPIFY_CUSTOMER_ACCOUNT_LOGOUT_URL: ${SHOPIFY_CUSTOMER_ACCOUNT_LOGOUT_URL}
      SHOPIFY_CUSTOMER_ACCOUNT_GRAPHQL_URL: ${SHOPIFY_CUSTOMER_ACCOUNT_GRAPHQL_URL}
      SHOPIFY_FEATURED_COLLECTION_HANDLE: ${SHOPIFY_FEATURED_COLLECTION_HANDLE:-homepage-featured}
      SHOPIFY_BEST_SELLERS_COLLECTION_HANDLE: ${SHOPIFY_BEST_SELLERS_COLLECTION_HANDLE:-best-sellers}
      # Google OAuth
      GOOGLE_OAUTH_CLIENT_ID: ${GOOGLE_OAUTH_CLIENT_ID}
      GOOGLE_OAUTH_CLIENT_SECRET: ${GOOGLE_OAUTH_CLIENT_SECRET}
      GOOGLE_OAUTH_REDIRECT_URI: ${GOOGLE_OAUTH_REDIRECT_URI}
      # Sepay Payment
      SEPAY_API_KEY: ${SEPAY_API_KEY}
      SEPAY_BANK_ACCOUNT: ${SEPAY_BANK_ACCOUNT}
      SEPAY_BANK_NAME: ${SEPAY_BANK_NAME}
      SEPAY_BANK_BIN: ${SEPAY_BANK_BIN}
      # Warehouse Integration
      WAREHOUSE_WEBHOOK_URL: ${WAREHOUSE_WEBHOOK_URL}
      WAREHOUSE_WEBHOOK_SECRET: ${WAREHOUSE_WEBHOOK_SECRET}
      # Misc
      REVALIDATE_SECRET: ${REVALIDATE_SECRET}
    restart: unless-stopped

  warehouse:
    build:
      context: .
      dockerfile: apps/warehouse-management/Dockerfile
      secrets:
        - env_warehouse
      args:
        # Public vars (baked into client bundle at build time)
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-https://warehouse.onlyperf.com}
        NEXT_PUBLIC_BASE_URL: ${NEXT_PUBLIC_BASE_URL:-https://onlyperf.com}
        NEXT_PUBLIC_SHOPIFY_ENABLED: ${NEXT_PUBLIC_SHOPIFY_ENABLED:-false}
    ports:
      - "3001:3001"
    environment:
      # Runtime environment variables
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL}
      # Authentication
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
      BETTER_AUTH_URL: ${BETTER_AUTH_URL}
      # Typesense
      TYPESENSE_HOST: ${TYPESENSE_HOST}
      TYPESENSE_PORT: ${TYPESENSE_PORT:-8108}
      TYPESENSE_PROTOCOL: ${TYPESENSE_PROTOCOL:-http}
      TYPESENSE_API_KEY: ${TYPESENSE_API_KEY}
      # Shopify (optional)
      SHOPIFY_ENABLED: ${SHOPIFY_ENABLED:-false}
      SHOPIFY_STORE_DOMAIN: ${SHOPIFY_STORE_DOMAIN}
      SHOPIFY_ADMIN_API_ACCESS_TOKEN: ${SHOPIFY_ADMIN_API_ACCESS_TOKEN}
      SHOPIFY_STOREFRONT_API_ACCESS_TOKEN: ${SHOPIFY_STOREFRONT_API_ACCESS_TOKEN}
      SHOPIFY_PRIVATE_STOREFRONT_API_TOKEN: ${SHOPIFY_PRIVATE_STOREFRONT_API_TOKEN}
      SHOPIFY_API_VERSION: ${SHOPIFY_API_VERSION:-2025-04}
      SHOPIFY_LOCATION_ID: ${SHOPIFY_LOCATION_ID}
      SHOPIFY_WEBHOOK_SECRET: ${SHOPIFY_WEBHOOK_SECRET}
      PUBLIC_STOREFRONT_API_TOKEN: ${PUBLIC_STOREFRONT_API_TOKEN}
      PUBLIC_STORE_DOMAIN: ${PUBLIC_STORE_DOMAIN}
    restart: unless-stopped

secrets:
  env_onlyperf:
    file: apps/onlyperf/.env
  env_warehouse:
    file: apps/warehouse-management/.env
